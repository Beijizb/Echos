# 内置 API 功能测试指南

本文档描述了如何测试内置音乐 API 功能。

## 测试环境准备

### 1. 安装依赖
```bash
cd os
flutter pub get
```

### 2. 运行应用
```bash
flutter run
```

## 功能测试清单

### 一、内置 API 音源配置测试

#### 1.1 添加内置音源
- [ ] 打开应用设置页面
- [ ] 进入"音源设置"页面
- [ ] 点击"添加音源"按钮
- [ ] 在音源类型下拉菜单中选择"内置 API"
- [ ] 验证界面显示:
  - 名称输入框(可选)
  - 蓝色信息提示框,内容:"此音源直接使用应用程序内置的音乐平台接口,无需配置服务器地址。"
  - 不显示 URL 输入框
- [ ] 输入名称(或留空使用默认名称"内置 API")
- [ ] 点击"添加"按钮
- [ ] 验证音源成功添加到列表

#### 1.2 编辑内置音源
- [ ] 在音源列表中找到已添加的内置音源
- [ ] 点击编辑按钮
- [ ] 验证:
  - 音源类型下拉菜单被禁用(不可更改)
  - 可以修改音源名称
  - 显示相同的信息提示框
- [ ] 修改名称
- [ ] 点击"保存"按钮
- [ ] 验证修改成功

#### 1.3 删除内置音源
- [ ] 在音源列表中找到内置音源
- [ ] 点击删除按钮
- [ ] 确认删除
- [ ] 验证音源从列表中移除

### 二、平台适配器功能测试

#### 2.1 网易云音乐平台
- [ ] 设置内置音源为当前音源
- [ ] 搜索歌曲(例如:"周杰伦")
- [ ] 验证:
  - 能正常返回搜索结果
  - 歌曲信息完整(标题、歌手、专辑、时长)
  - 封面图片正常加载
- [ ] 获取歌曲播放地址
- [ ] 验证:
  - 返回有效的播放 URL
  - 音质信息正确
- [ ] 播放歌曲
- [ ] 验证:
  - 能正常播放
  - 播放进度正常
  - 歌词同步正常

#### 2.2 QQ 音乐平台
- [ ] 重复 2.1 的所有测试步骤
- [ ] 特别注意 QQ 音乐特有的:
  - VIP 歌曲标识
  - 试听限制提示

#### 2.3 酷狗音乐平台
- [ ] 重复 2.1 的所有测试步骤
- [ ] 特别注意酷狗音乐特有的:
  - 音质选项(标准、HQ、SQ)
  - 封面图片处理

#### 2.4 酷我音乐平台
- [ ] 重复 2.1 的所有测试步骤
- [ ] 特别注意酷我音乐特有的:
  - API 响应格式差异
  - 歌词格式处理

### 三、PlaylistService 集成测试

#### 3.1 搜索功能
- [ ] 使用 PlaylistService 搜索歌曲
- [ ] 验证:
  - 能正确调用内置平台适配器
  - 返回统一格式的搜索结果
  - 错误处理正确

#### 3.2 获取歌曲详情
- [ ] 通过歌曲 ID 获取详细信息
- [ ] 验证:
  - 返回完整的歌曲信息
  - 包含所有必需字段

#### 3.3 获取播放地址
- [ ] 请求歌曲播放 URL
- [ ] 验证:
  - 返回有效的播放地址
  - 包含音质信息
  - 包含文件大小和格式信息

#### 3.4 获取歌词
- [ ] 请求歌曲歌词
- [ ] 验证:
  - 返回正确格式的歌词(LRC 格式)
  - 时间轴正确
  - 支持翻译歌词(如果有)

### 四、错误处理测试

#### 4.1 网络错误
- [ ] 断开网络连接
- [ ] 尝试搜索歌曲
- [ ] 验证:
  - 显示友好的错误提示
  - 不会导致应用崩溃
  - 错误信息准确描述问题

#### 4.2 API 限流
- [ ] 快速连续发送多个请求
- [ ] 验证:
  - 正确处理限流响应
  - 显示适当的等待提示
  - 自动重试机制工作正常

#### 4.3 歌曲不可用
- [ ] 搜索已下架或地区限制的歌曲
- [ ] 验证:
  - 显示明确的不可用提示
  - 提供原因说明(版权、地区等)

### 五、性能测试

#### 5.1 响应时间
- [ ] 测量搜索请求响应时间
- [ ] 验证:
  - 平均响应时间 < 2 秒
  - 95% 请求在 3 秒内完成

#### 5.2 并发请求
- [ ] 同时搜索多个关键词
- [ ] 验证:
  - 所有请求都能正常处理
  - 不会出现数据混乱
  - 内存使用合理

#### 5.3 内存泄漏
- [ ] 长时间使用应用(至少 30 分钟)
- [ ] 频繁切换歌曲和音源
- [ ] 验证:
  - 内存使用稳定
  - 没有明显的内存增长

### 六、跨平台测试

#### 6.1 Windows 平台
- [ ] Material Design UI 正常显示
- [ ] Fluent Design UI 正常显示(如适用)
- [ ] 所有功能正常工作

#### 6.2 macOS 平台
- [ ] Cupertino UI 正常显示
- [ ] 所有功能正常工作
- [ ] 快捷键正常工作

#### 6.3 Linux 平台
- [ ] Material Design UI 正常显示
- [ ] 所有功能正常工作

#### 6.4 Android 平台
- [ ] Material Design UI 正常显示
- [ ] 触摸交互流畅
- [ ] 后台播放正常

#### 6.5 iOS 平台
- [ ] Cupertino UI 正常显示
- [ ] 触摸交互流畅
- [ ] 后台播放正常

## 测试报告模板

### 测试环境
- 操作系统:
- Flutter 版本:
- Dart 版本:
- 应用版本:
- 测试日期:

### 测试结果

#### 功能测试
| 测试项 | 状态 | 备注 |
|--------|------|------|
| 内置音源配置 | ✅/❌ | |
| 网易云音乐平台 | ✅/❌ | |
| QQ 音乐平台 | ✅/❌ | |
| 酷狗音乐平台 | ✅/❌ | |
| 酷我音乐平台 | ✅/❌ | |
| PlaylistService 集成 | ✅/❌ | |
| 错误处理 | ✅/❌ | |

#### 性能测试
| 指标 | 目标值 | 实际值 | 状态 |
|------|--------|--------|------|
| 平均响应时间 | < 2s | | ✅/❌ |
| 95% 响应时间 | < 3s | | ✅/❌ |
| 内存使用 | 稳定 | | ✅/❌ |

### 发现的问题
1. 
2. 
3. 

### 改进建议
1. 
2. 
3. 

## 自动化测试

### 单元测试

运行所有单元测试:
```bash
flutter test
```

运行特定测试文件:
```bash
flutter test test/services/music_api/platform_factory_test.dart
```

### 集成测试

运行集成测试:
```bash
flutter test integration_test/
```

## 调试技巧

### 1. 启用详细日志
在 `main.dart` 中设置:
```dart
DeveloperModeService().setLogLevel(LogLevel.verbose);
```

### 2. 查看网络请求
使用 Flutter DevTools 的 Network 面板查看所有 HTTP 请求和响应。

### 3. 性能分析
使用 Flutter DevTools 的 Performance 面板分析性能瓶颈。

## 常见问题排查

### 问题 1: 搜索无结果
**可能原因:**
- 网络连接问题
- API 服务不可用
- 搜索关键词问题

**排查步骤:**
1. 检查网络连接
2. 查看错误日志
3. 尝试其他关键词
4. 切换到其他音源

### 问题 2: 播放失败
**可能原因:**
- 播放 URL 已过期
- 音频格式不支持
- 网络带宽不足

**排查步骤:**
1. 重新获取播放地址
2. 检查音频格式
3. 测试网络速度
4. 查看播放器错误信息

### 问题 3: 歌词不同步
**可能原因:**
- 歌词文件格式错误
- 时间轴偏移
- 播放器时间不准确

**排查步骤:**
1. 检查歌词格式
2. 手动调整时间轴偏移
3. 重启播放器
4. 尝试其他歌曲

## 测试数据

### 推荐的测试歌曲
1. **流行歌曲**: "周杰伦 - 晴天"
2. **经典老歌**: "邓丽君 - 月亮代表我的心"
3. **英文歌曲**: "Taylor Swift - Shake It Off"
4. **VIP 歌曲**: 用于测试版权提示
5. **冷门歌曲**: 用于测试搜索准确性

### 测试关键词
- 歌手名: "周杰伦", "Taylor Swift"
- 歌曲名: "晴天", "七里香"
- 专辑名: "范特西", "叶惠美"
- 混合搜索: "周杰伦 晴天"
- 特殊字符: "歌名 (Live版)"

## 总结

完成所有测试项后,请:
1. 填写测试报告
2. 记录所有发现的问题
3. 提出改进建议
4. 更新相关文档